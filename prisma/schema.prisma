// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("client") // client, admin
  theme         String    @default("light") // light, dark
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  whatsappConnections WhatsAppConnection[]
  webhookLogs         WebhookLog[]
  contacts            Contact[]
  contactGroups       ContactGroup[]
  quickReplies        QuickReply[]
  scheduledMessages   ScheduledMessage[]
  notifications       Notification[]
}

model WhatsAppConnection {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  phoneNumber     String
  phoneNumberId   String   @unique
  wabaId          String
  businessName    String?
  accessToken     String?
  status          String   @default("pending") // pending, connected, disconnected, error

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  connectedAt     DateTime?

  webhookLogs     WebhookLog[]
  scheduledMessages ScheduledMessage[]
}

model WebhookLog {
  id              String   @id @default(cuid())
  connectionId    String?
  connection      WhatsAppConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  eventType       String   // message, status, error, etc.
  payload         String   // JSON string of the webhook payload
  processed       Boolean  @default(false)

  createdAt       DateTime @default(now())
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
}

model Message {
  id              String   @id @default(cuid())
  connectionId    String

  direction       String   // inbound, outbound
  from            String
  to              String
  messageType     String   // text, image, document, etc.
  content         String
  mediaUrl        String?
  status          String   @default("pending") // pending, sent, delivered, read, failed
  whatsappMessageId String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalUsers      Int      @default(0)
  newUsers        Int      @default(0)
  totalConnections Int     @default(0)
  messagesIn      Int      @default(0)
  messagesOut     Int      @default(0)
  webhookEvents   Int      @default(0)

  createdAt       DateTime @default(now())
}

model MessageTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  content     String
  category    String   @default("general") // general, greeting, support, sales
  variables   String?  // JSON array of variable names like ["name", "order_id"]
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChatbotFlow {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isActive    Boolean  @default(true)
  triggerType String   @default("keyword") // keyword, all, first_message, schedule, webhook
  triggerValue String? // The keyword or regex to trigger

  nodes       ChatbotNode[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChatbotNode {
  id          String   @id @default(cuid())
  flowId      String
  flow        ChatbotFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  nodeType    String   // message, question, condition, action, ai_response, delay, image, buttons, list, location
  content     String   // The message content or AI prompt
  options     String?  // JSON for buttons/options
  nextNodeId  String?  // ID of next node (for linear flow)
  position    Int      @default(0)
  delaySeconds Int?    // For delay nodes

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChatbotConversation {
  id              String   @id @default(cuid())
  connectionId    String
  phoneNumber     String
  currentFlowId   String?
  currentNodeId   String?
  context         String?  // JSON for conversation context/variables
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  key         String   @unique
  permissions String   // JSON array of permissions
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============ NUEVAS FUNCIONALIDADES ============

// 1. Mensajes programados
model ScheduledMessage {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectionId    String
  connection      WhatsAppConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  recipientPhone  String
  content         String
  messageType     String   @default("text") // text, image, template
  mediaUrl        String?
  scheduledAt     DateTime
  status          String   @default("pending") // pending, sent, failed, cancelled
  sentAt          DateTime?
  errorMessage    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 2. Contactos con etiquetas
model Contact {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  phoneNumber     String
  name            String?
  email           String?
  company         String?
  avatarUrl       String?
  isBlocked       Boolean  @default(false)
  lastMessageAt   DateTime?

  tags            ContactTagRelation[]
  groups          ContactGroupRelation[]
  notes           ContactNote[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, phoneNumber])
}

model ContactTag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#6b7280") // gray color

  contacts    ContactTagRelation[]

  createdAt   DateTime @default(now())
}

model ContactTagRelation {
  id          String   @id @default(cuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tagId       String
  tag         ContactTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
}

// 8. Grupos de contactos
model ContactGroup {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String   @default("#3b82f6") // blue color

  contacts    ContactGroupRelation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ContactGroupRelation {
  id          String   @id @default(cuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  groupId     String
  group       ContactGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([contactId, groupId])
}

// 5. Respuestas r√°pidas
model QuickReply {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  shortcut    String   // e.g., "/hola", "/precio"
  title       String
  content     String
  category    String   @default("general")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, shortcut])
}

// 9. Notas en contactos
model ContactNote {
  id          String   @id @default(cuid())
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  content     String
  isPinned    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 7. Notificaciones
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // message, system, alert, reminder
  title       String
  content     String
  link        String?  // URL to navigate when clicked
  isRead      Boolean  @default(false)

  createdAt   DateTime @default(now())
}
